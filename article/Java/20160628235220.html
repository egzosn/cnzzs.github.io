<article class="markdown-body entry-content" itemprop="text"><h1><a id="user-content-pay-java-parent" class="anchor" href="#pay-java-parent" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>pay-java-parent</h1>

    <h2><a id="user-content-整合支付模块微信支付支付宝" class="anchor" href="#整合支付模块微信支付支付宝" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>整合支付模块（微信支付，支付宝）</h2>

    <h6><a id="user-content-支持多种支付类型多支付账户简单快速完成支付模块的开发目前只支持微信支付与支付宝支付很希望更多友友一起添加新的支付" class="anchor" href="#支持多种支付类型多支付账户简单快速完成支付模块的开发目前只支持微信支付与支付宝支付很希望更多友友一起添加新的支付项目连接:https://github.com/egzosn/pay-java-parent" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>支持多种支付类型多支付账户，简单快速完成支付模块的开发。目前只支持微信支付与支付宝支付，很希望更多友友一起添加新的支付。项目连接:https://github.com/egzosn/pay-java-parent</h6>

    <h4><a id="user-content-一--快速入门" class="anchor" href="#一--快速入门" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a>一.  快速入门</h4>

    <ol>
        <li>支付整合配置</li>
    </ol>

    <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">PayResponse</span> {
    <span class="pl-k">@Resource</span>
    <span class="pl-k">private</span> <span class="pl-smi">AutowireCapableBeanFactory</span> spring;

    <span class="pl-k">private</span> <span class="pl-smi">PayConfigStorage</span> storage;

    <span class="pl-k">private</span> <span class="pl-smi">PayService</span> service;

    <span class="pl-k">private</span> <span class="pl-smi">PayMessageRouter</span> router;

    <span class="pl-k">public</span> <span class="pl-en">PayResponse</span>() {

    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * 初始化支付配置</span>
<span class="pl-c">     * @param apyAccount 账户信息</span>
<span class="pl-c">     * @see ApyAccount 对应表结构详情--》 /db/apy_account.sql</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">init</span>(<span class="pl-smi">ApyAccount</span> <span class="pl-v">apyAccount</span>) {


        <span class="pl-v">this</span><span class="pl-k">.</span>service <span class="pl-k">=</span> getPayService(apyAccount);
        <span class="pl-v">this</span><span class="pl-k">.</span>storage <span class="pl-k">=</span> service<span class="pl-k">.</span>getPayConfigStorage();

        buildRouter(apyAccount<span class="pl-k">.</span>getPayId());
    }


    <span class="pl-c">/**</span>
<span class="pl-c">     * 根据不同的账户类型 初始化支付配置</span>
<span class="pl-c">     * 一个账户类型可支持多个账户</span>
<span class="pl-c">     * @param apyAccount 账户信息</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-smi">PayService</span> <span class="pl-en">getPayService</span>(<span class="pl-smi">ApyAccount</span> <span class="pl-v">apyAccount</span>){

        <span class="pl-k">switch</span> (apyAccount<span class="pl-k">.</span>getPayType()){
            <span class="pl-k">case</span> <span class="pl-c1">0</span><span class="pl-k">:</span>
                <span class="pl-smi">AliPayConfigStorage</span> aliPayConfigStorage <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">AliPayConfigStorage</span>();
                aliPayConfigStorage<span class="pl-k">.</span>setPartner(apyAccount<span class="pl-k">.</span>getPartner());
                aliPayConfigStorage<span class="pl-k">.</span>setAli_public_key(apyAccount<span class="pl-k">.</span>getPublicKey());
                aliPayConfigStorage<span class="pl-k">.</span>setKeyPrivate(apyAccount<span class="pl-k">.</span>getPrivateKey());
                aliPayConfigStorage<span class="pl-k">.</span>setInputCharset(apyAccount<span class="pl-k">.</span>getInputCharset());
                aliPayConfigStorage<span class="pl-k">.</span>setNotifyUrl(apyAccount<span class="pl-k">.</span>getNotifyUrl());
                aliPayConfigStorage<span class="pl-k">.</span>setSignType(apyAccount<span class="pl-k">.</span>getSignType());
                aliPayConfigStorage<span class="pl-k">.</span>setSeller(apyAccount<span class="pl-k">.</span>getSeller());
                aliPayConfigStorage<span class="pl-k">.</span>setPayType(apyAccount<span class="pl-k">.</span>getPayType());
                <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">AliPayService</span>(aliPayConfigStorage);
            <span class="pl-k">case</span> <span class="pl-c1">1</span><span class="pl-k">:</span>
                <span class="pl-smi">WxPayConfigStorage</span> wxPayConfigStorage <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">WxPayConfigStorage</span>();
                wxPayConfigStorage<span class="pl-k">.</span>setMchId(apyAccount<span class="pl-k">.</span>getPartner());
                wxPayConfigStorage<span class="pl-k">.</span>setAppSecret(apyAccount<span class="pl-k">.</span>getPublicKey());
                wxPayConfigStorage<span class="pl-k">.</span>setAppid(apyAccount<span class="pl-k">.</span>getAppid());
                wxPayConfigStorage<span class="pl-k">.</span>setKeyPrivate(apyAccount<span class="pl-k">.</span>getPrivateKey());
                wxPayConfigStorage<span class="pl-k">.</span>setInputCharset(apyAccount<span class="pl-k">.</span>getInputCharset());
                wxPayConfigStorage<span class="pl-k">.</span>setNotifyUrl(apyAccount<span class="pl-k">.</span>getNotifyUrl());
                wxPayConfigStorage<span class="pl-k">.</span>setSignType(apyAccount<span class="pl-k">.</span>getSignType());
                wxPayConfigStorage<span class="pl-k">.</span>setPayType(apyAccount<span class="pl-k">.</span>getPayType());
                <span class="pl-k">return</span>  <span class="pl-k">new</span> <span class="pl-smi">WxPayService</span>(wxPayConfigStorage);
            <span class="pl-k">default</span><span class="pl-k">:</span>

        }
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }


    <span class="pl-c">/**</span>
<span class="pl-c">     * 配置路由</span>
<span class="pl-c">     * @param payId 指定账户id，用户多微信支付多支付宝支付</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">buildRouter</span>(<span class="pl-smi">Integer</span> <span class="pl-v">payId</span>) {
        router <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">PayMessageRouter</span>(<span class="pl-v">this</span><span class="pl-k">.</span>service);
        router
                .rule()
                .async(<span class="pl-c1">false</span>)
                .msgType(<span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_TEXT</span>)
                .event(<span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_ALIPAY</span>)
                .handler(autowire(<span class="pl-k">new</span> <span class="pl-smi">AliPayMessageHandler</span>(payId)))
                .end()
                .rule()
                .async(<span class="pl-c1">false</span>)
                .msgType(<span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_XML</span>)
                .event(<span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_WXPAY</span>)
                .handler(autowire(<span class="pl-k">new</span> <span class="pl-smi">WxPayMessageHandler</span>(payId)))
                .end()
        ;
    }


    <span class="pl-k">private</span> <span class="pl-smi">PayMessageHandler</span> <span class="pl-en">autowire</span>(<span class="pl-smi">PayMessageHandler</span> <span class="pl-v">handler</span>) {
        spring<span class="pl-k">.</span>autowireBean(handler);
        <span class="pl-k">return</span> handler;
    }

    <span class="pl-k">public</span> <span class="pl-smi">PayConfigStorage</span> <span class="pl-en">getStorage</span>() {
        <span class="pl-k">return</span> storage;
    }

    <span class="pl-k">public</span> <span class="pl-smi">PayService</span> <span class="pl-en">getService</span>() {
        <span class="pl-k">return</span> service;
    }

    <span class="pl-k">public</span> <span class="pl-smi">PayMessageRouter</span> <span class="pl-en">getRouter</span>() {
        <span class="pl-k">return</span> router;
    }
}
</pre></div>

    <p>支付响应PayResponse的获取</p>

    <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ApyAccountService</span> {


    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">ApyAccountDao</span> dao;

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">AutowireCapableBeanFactory</span> spring;

    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-k">static</span> <span class="pl-k">Map&lt;<span class="pl-smi">Integer</span>, <span class="pl-smi">PayResponse</span>&gt;</span> payResponses <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">HashMap&lt;<span class="pl-smi">Integer</span>, <span class="pl-smi">PayResponse</span>&gt;</span>();


    <span class="pl-c">/**</span>
<span class="pl-c">     *  获取支付响应</span>
<span class="pl-c">     * @param id 账户id</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-smi">PayResponse</span> <span class="pl-en">getPayResponse</span>(<span class="pl-smi">Integer</span> <span class="pl-v">id</span>) {

        <span class="pl-smi">PayResponse</span> payResponse <span class="pl-k">=</span> payResponses<span class="pl-k">.</span>get(id);
        <span class="pl-k">if</span> (mpResponse <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
            <span class="pl-smi">ApyAccount</span> apyAccount <span class="pl-k">=</span> dao<span class="pl-k">.</span>get(id);
            <span class="pl-k">if</span> (apyAccount <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
                throwError(<span class="pl-k">-</span><span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">"</span>无法查询<span class="pl-pds">"</span></span>);
            }
            payResponse <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">PayResponse</span>();
            spring<span class="pl-k">.</span>autowireBean(payResponse);
            payResponse<span class="pl-k">.</span>init(apyAccount);
            payResponses<span class="pl-k">.</span>put(id, payResponse);
            <span class="pl-c">// 查询</span>
        }
        <span class="pl-k">return</span> payResponse;
    }



}
</pre></div>

    <ol>
        <li> 根据账户id与业务id，组拼订单信息（支付宝、微信支付订单）获取支付信息所需的数据</li>
    </ol>

    <div class="highlight highlight-source-java"><pre>  <span class="pl-c">//获取对应的支付账户操作工具（可根据账户id）</span>
  <span class="pl-smi">PayResponse</span> payResponse <span class="pl-k">=</span>  service<span class="pl-k">.</span>getPayResponse(payId);;
  <span class="pl-c">//这里之所以用Object，因为微信需返回Map， 支付吧String。</span>
  <span class="pl-smi">Object</span> orderInfo <span class="pl-k">=</span> payResponse<span class="pl-k">.</span>getService()<span class="pl-k">.</span>orderInfo(<span class="pl-s"><span class="pl-pds">"</span>订单title<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>摘要<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-smi">BigDecimal</span>(<span class="pl-c1">0.01</span>), <span class="pl-s"><span class="pl-pds">"</span>tradeNo<span class="pl-pds">"</span></span>);
  <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(orderInfo);
</pre></div>

    <ol>
        <li>支付回调</li>
    </ol>

    <div class="highlight highlight-source-java"><pre>     <span class="pl-c">/**</span>
<span class="pl-c">     * 微信或者支付宝回调地址</span>
<span class="pl-c">     * @param request</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@ResponseBody</span>
    <span class="pl-k">@RequestMapping</span>(<span class="pl-c1">value</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>payBack{payId}.json<span class="pl-pds">"</span></span>)
    <span class="pl-k">public</span> <span class="pl-smi">String</span> payBack(<span class="pl-smi">HttpServletRequest</span> request, <span class="pl-k">@PathVariable</span> <span class="pl-smi">Integer</span> payId){
        <span class="pl-c">//根据账户id，获取对应的支付账户操作工具</span>
        <span class="pl-smi">PayResponse</span> payResponse <span class="pl-k">=</span> service<span class="pl-k">.</span>getPayResponse(payId);
        <span class="pl-smi">PayConfigStorage</span> storage <span class="pl-k">=</span> payResponse<span class="pl-k">.</span>getStorage();
        <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> params <span class="pl-k">=</span> request2Params(request, storage<span class="pl-k">.</span>getPayType());
        <span class="pl-k">if</span> (<span class="pl-c1">null</span> <span class="pl-k">==</span> params){
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>fail<span class="pl-pds">"</span></span>;
        }


        <span class="pl-k">if</span> (payResponse<span class="pl-k">.</span>getService()<span class="pl-k">.</span>verify(params)){

            <span class="pl-smi">String</span> msgType <span class="pl-k">=</span> <span class="pl-c1">null</span>;
            <span class="pl-k">if</span> (<span class="pl-c1">0</span> <span class="pl-k">==</span> storage<span class="pl-k">.</span>getPayType()){
                msgType <span class="pl-k">=</span> <span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_TEXT</span>;
            }<span class="pl-k">else</span> {
                msgType <span class="pl-k">=</span> <span class="pl-smi">PayConsts</span><span class="pl-c1"><span class="pl-k">.</span>MSG_XML</span>;
            }
            <span class="pl-smi">PayMessage</span> message <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">PayMessage</span>(params, storage<span class="pl-k">.</span>getPayType(), msgType);
            <span class="pl-smi">PayOutMessage</span> outMessage <span class="pl-k">=</span> payResponse<span class="pl-k">.</span>getRouter()<span class="pl-k">.</span>route(message);
            <span class="pl-k">return</span> outMessage<span class="pl-k">.</span>toMessage();
        }

        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>fail<span class="pl-pds">"</span></span>;
    }


    <span class="pl-c">/**</span>
<span class="pl-c">     * 根据请求获取参数Map</span>
<span class="pl-c">     * @param request</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> request2Params(<span class="pl-smi">HttpServletRequest</span> request, <span class="pl-smi">Short</span> payType){

         <span class="pl-k">if</span> (<span class="pl-c1">1</span> <span class="pl-k">==</span> storage<span class="pl-k">.</span>getPayType()){
            <span class="pl-c">//根据请求文件流里获取</span>
            <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> data <span class="pl-k">=</span> inputStream2Map(request);
            <span class="pl-k">if</span> (<span class="pl-c1">null</span> <span class="pl-k">==</span> data <span class="pl-k">||</span> data<span class="pl-k">.</span>size() <span class="pl-k">==</span> <span class="pl-c1">0</span>){
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
            }
            <span class="pl-k">return</span> data;
         }

        <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-k">String</span>[]&gt;</span> requestParams <span class="pl-k">=</span> request<span class="pl-k">.</span>getParameterMap();

        <span class="pl-k">Map&lt;<span class="pl-smi">String</span>,<span class="pl-smi">String</span>&gt;</span> params <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>,<span class="pl-smi">String</span>&gt;</span>();
        <span class="pl-k">for</span> (<span class="pl-smi">Iterator</span> iter <span class="pl-k">=</span> requestParams<span class="pl-k">.</span>keySet()<span class="pl-k">.</span>iterator(); iter<span class="pl-k">.</span>hasNext();) {
            <span class="pl-smi">String</span> name <span class="pl-k">=</span> (<span class="pl-smi">String</span>) iter<span class="pl-k">.</span>next();
            <span class="pl-k">String</span>[] values <span class="pl-k">=</span> requestParams<span class="pl-k">.</span>get(name);
            <span class="pl-smi">String</span> valueStr <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;
            <span class="pl-k">for</span> (<span class="pl-k">int</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&lt;</span> values<span class="pl-k">.</span>length; i<span class="pl-k">++</span>) {
                valueStr <span class="pl-k">=</span> (i <span class="pl-k">==</span> values<span class="pl-k">.</span>length <span class="pl-k">-</span> <span class="pl-c1">1</span>) <span class="pl-k">?</span> valueStr <span class="pl-k">+</span> values[i]
                        <span class="pl-k">:</span> valueStr <span class="pl-k">+</span> values[i] <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>;
            }
            <span class="pl-c">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span>
            <span class="pl-c">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span>
            params<span class="pl-k">.</span>put(name, valueStr);
        }

        <span class="pl-k">return</span> params;
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * 从请求中获取xml文件流，转化为map</span>
<span class="pl-c">     * @param request</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
        <span class="pl-k">public</span> <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> inputStream2Map(<span class="pl-smi">HttpServletRequest</span> request) {
            <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> map <span class="pl-k">=</span> <span class="pl-c1">null</span>;<span class="pl-c">//将微信发出的Xml转Map</span>
            <span class="pl-k">try</span> {
                map <span class="pl-k">=</span> <span class="pl-smi">WxpayCore</span><span class="pl-k">.</span>toMap(request<span class="pl-k">.</span>getInputStream());
            } <span class="pl-k">catch</span> (<span class="pl-smi">IOException</span> e) {
                e<span class="pl-k">.</span>printStackTrace();
            }
            <span class="pl-k">return</span> map;
        }
</pre></div>
</article>

